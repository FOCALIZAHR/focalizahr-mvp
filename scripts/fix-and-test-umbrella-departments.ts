// scripts/fix-and-test-umbrella-departments.ts
// PASO 1: Diagn√≥stico + Correcci√≥n + Validaci√≥n

import { prisma } from '../src/lib/prisma';

async function diagnosticAndFix() {
  console.log('üîç PASO 1: DIAGN√ìSTICO Y CORRECCI√ìN DE DEPARTAMENTOS PARAGUAS');
  console.log('=============================================================\n');

  try {
    // ==========================================
    // FASE 1: DIAGN√ìSTICO - Identificar problemas
    // ==========================================
    console.log('üìä FASE 1: DIAGN√ìSTICO\n');

    // 1.1 Buscar departamentos con nombre "sin asignar"
    const deptsByName = await prisma.department.findMany({
      where: {
        OR: [
          { displayName: { contains: 'sin asignar', mode: 'insensitive' } },
          { displayName: { contains: 'sin_asignar', mode: 'insensitive' } },
          { displayName: { contains: 'no asignado', mode: 'insensitive' } }
        ]
      },
      select: {
        id: true,
        displayName: true,
        standardCategory: true,
        parentId: true,
        level: true,
        unitType: true,
        accountId: true,
        account: {
          select: {
            companyName: true
          }
        },
        _count: {
          select: {
            participants: true
          }
        }
      }
    });

    console.log(`Encontrados ${deptsByName.length} departamentos con "sin asignar" en el nombre:\n`);

    const problemDepts: typeof deptsByName = [];
    const correctDepts: typeof deptsByName = [];

    deptsByName.forEach((dept) => {
      const isCorrect = 
        dept.standardCategory === 'sin_asignar' &&
        dept.level === 3 &&
        dept.unitType === 'departamento' &&
        dept.parentId === null;

      if (isCorrect) {
        correctDepts.push(dept);
      } else {
        problemDepts.push(dept);
      }

      const status = isCorrect ? '‚úÖ CORRECTO' : '‚ùå PROBLEMA';
      console.log(`${status} - "${dept.displayName}" (${dept.account.companyName})`);
      console.log(`   ID: ${dept.id}`);
      console.log(`   standardCategory: ${dept.standardCategory} ${dept.standardCategory !== 'sin_asignar' ? '‚ùå' : '‚úÖ'}`);
      console.log(`   level: ${dept.level} ${dept.level !== 3 ? '‚ùå' : '‚úÖ'}`);
      console.log(`   unitType: ${dept.unitType} ${dept.unitType !== 'departamento' ? '‚ùå' : '‚úÖ'}`);
      console.log(`   parentId: ${dept.parentId || 'null'} ${dept.parentId !== null ? '‚ùå' : '‚úÖ'}`);
      console.log(`   Participantes asignados: ${dept._count.participants}`);
      console.log();
    });

    // ==========================================
    // FASE 2: RESUMEN DEL DIAGN√ìSTICO
    // ==========================================
    console.log('\nüìã RESUMEN DEL DIAGN√ìSTICO:');
    console.log('=========================\n');
    console.log(`‚úÖ Departamentos correctos: ${correctDepts.length}`);
    console.log(`‚ùå Departamentos problem√°ticos: ${problemDepts.length}\n`);

    if (problemDepts.length === 0) {
      console.log('üéâ ¬°No se encontraron problemas! Todos los departamentos paraguas est√°n correctos.\n');
      console.log('Procediendo a verificar que cada cuenta tenga su departamento paraguas...\n');
    } else {
      console.log('‚ö†Ô∏è Se encontraron departamentos con configuraci√≥n incorrecta.\n');
      console.log('Departamentos a corregir:\n');
      problemDepts.forEach((dept, index) => {
        console.log(`${index + 1}. ${dept.account.companyName}: "${dept.displayName}"`);
        console.log(`   ID: ${dept.id}`);
        console.log(`   Participantes afectados: ${dept._count.participants}`);
        console.log();
      });
    }

    // ==========================================
    // FASE 3: CORRECCI√ìN (si hay problemas)
    // ==========================================
    if (problemDepts.length > 0) {
      console.log('\nüîß FASE 2: CORRECCI√ìN DE DEPARTAMENTOS\n');
      console.log('¬øDeseas proceder con la correcci√≥n? (Esto actualizar√° la base de datos)\n');
      console.log('Se corregir√°n los siguientes campos:');
      console.log('  - standardCategory ‚Üí "sin_asignar"');
      console.log('  - parentId ‚Üí null');
      console.log('  - level ‚Üí 3');
      console.log('  - unitType ‚Üí "departamento"\n');

      // En un script real, podr√≠as agregar confirmaci√≥n interactiva
      // Por ahora, procedemos autom√°ticamente
      console.log('Procediendo con la correcci√≥n autom√°tica...\n');

      let correctedCount = 0;

      for (const dept of problemDepts) {
        console.log(`üîÑ Corrigiendo: ${dept.id} - "${dept.displayName}" (${dept.account.companyName})`);
        
        const before = {
          standardCategory: dept.standardCategory,
          parentId: dept.parentId,
          level: dept.level,
          unitType: dept.unitType
        };

        await prisma.department.update({
          where: { id: dept.id },
          data: {
            standardCategory: 'sin_asignar',
            parentId: null,
            level: 3,
            unitType: 'departamento'
          }
        });

        correctedCount++;

        console.log(`   ‚úÖ Corregido:`);
        console.log(`      standardCategory: "${before.standardCategory}" ‚Üí "sin_asignar"`);
        console.log(`      parentId: ${before.parentId || 'null'} ‚Üí null`);
        console.log(`      level: ${before.level} ‚Üí 3`);
        console.log(`      unitType: "${before.unitType}" ‚Üí "departamento"`);
        console.log();
      }

      console.log(`‚úÖ Correcci√≥n completada: ${correctedCount} departamentos actualizados\n`);
    }

    // ==========================================
    // FASE 4: VERIFICACI√ìN POST-CORRECCI√ìN
    // ==========================================
    console.log('\nüîç FASE 3: VERIFICACI√ìN POST-CORRECCI√ìN\n');

    // Verificar que cada cuenta activa tenga su departamento paraguas
    const activeAccounts = await prisma.account.findMany({
      where: {
        status: 'ACTIVE'
      },
      select: {
        id: true,
        companyName: true
      }
    });

    console.log(`Verificando ${activeAccounts.length} cuentas activas...\n`);

    const accountsWithoutUmbrella: typeof activeAccounts = [];
    const accountsWithUmbrella: typeof activeAccounts = [];

    for (const account of activeAccounts) {
      const umbrella = await prisma.department.findFirst({
        where: {
          accountId: account.id,
          standardCategory: 'sin_asignar'
        }
      });

      if (umbrella) {
        accountsWithUmbrella.push(account);
        console.log(`‚úÖ ${account.companyName}: Tiene departamento paraguas (${umbrella.displayName})`);
      } else {
        accountsWithoutUmbrella.push(account);
        console.log(`‚ùå ${account.companyName}: NO tiene departamento paraguas`);
      }
    }

    // ==========================================
    // FASE 5: RESUMEN FINAL
    // ==========================================
    console.log('\n\nüìä RESUMEN FINAL:');
    console.log('=================\n');
    console.log(`Total cuentas activas: ${activeAccounts.length}`);
    console.log(`‚úÖ Con departamento paraguas: ${accountsWithUmbrella.length}`);
    console.log(`‚ùå Sin departamento paraguas: ${accountsWithoutUmbrella.length}\n`);

    if (accountsWithoutUmbrella.length > 0) {
      console.log('‚ö†Ô∏è Las siguientes cuentas NO tienen departamento paraguas:');
      console.log('   (Se crear√° autom√°ticamente en la primera carga de participantes)\n');
      accountsWithoutUmbrella.forEach((account) => {
        console.log(`   - ${account.companyName} (ID: ${account.id})`);
      });
      console.log();
    }

    if (problemDepts.length > 0) {
      console.log('‚úÖ Todos los departamentos problem√°ticos han sido corregidos.');
      console.log('‚úÖ La carga de participantes deber√≠a funcionar correctamente ahora.\n');
    } else {
      console.log('‚úÖ No se encontraron problemas en la configuraci√≥n.');
      console.log('‚úÖ El sistema est√° listo para cargar participantes.\n');
    }

    // ==========================================
    // FASE 6: PRUEBA DE CONCEPTO (DRY RUN)
    // ==========================================
    console.log('\nüß™ FASE 4: PRUEBA DE CONCEPTO (DRY RUN)\n');
    console.log('Simulando b√∫squeda del departamento paraguas para cada cuenta...\n');

    for (const account of activeAccounts.slice(0, 3)) { // Solo primeras 3 para brevedad
      console.log(`\nüîç Cuenta: ${account.companyName}`);
      
      const searchResult = await prisma.department.findFirst({
        where: {
          accountId: account.id,
          standardCategory: 'sin_asignar'
        },
        select: {
          id: true,
          displayName: true,
          standardCategory: true,
          parentId: true,
          level: true
        }
      });

      if (searchResult) {
        console.log('   ‚úÖ B√∫squeda exitosa:');
        console.log(`      ID: ${searchResult.id}`);
        console.log(`      Nombre: "${searchResult.displayName}"`);
        console.log(`      Categor√≠a: ${searchResult.standardCategory}`);
        console.log(`      Level: ${searchResult.level}`);
        console.log(`      ParentId: ${searchResult.parentId || 'null'}`);
        console.log('   ‚úÖ La API de carga encontrar√° este departamento correctamente');
      } else {
        console.log('   ‚ÑπÔ∏è  No existe departamento paraguas');
        console.log('   ‚úÖ La API crear√° uno autom√°ticamente en la primera carga');
      }
    }

    console.log('\n=============================================================');
    console.log('üèÅ DIAGN√ìSTICO Y CORRECCI√ìN COMPLETADOS');
    console.log('=============================================================\n');

    console.log('üìã PR√ìXIMOS PASOS:\n');
    console.log('1. ‚úÖ Revisar este reporte');
    console.log('2. ‚úÖ Si todo est√° correcto, proceder a probar carga de participantes');
    console.log('3. ‚úÖ Monitorear logs en la primera carga para confirmar funcionamiento\n');

  } catch (error) {
    console.error('\n‚ùå Error durante el diagn√≥stico:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Ejecutar
diagnosticAndFix()
  .catch((error) => {
    console.error('Error fatal:', error);
    process.exit(1);
  });