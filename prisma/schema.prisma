// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// âœ… ENUM GENDER - AGREGADO PARA DEMOGRAFÃA
enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
}

// âœ… ENUM ACCOUNT STATUS - AGREGADO PARA GESTIÃ“N DE CUENTAS
enum AccountStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  INACTIVE
}

// TABLA 1: Cuentas empresa (multi-tenancy)
model Account {
  id               String        @id @default(cuid())
  companyName      String        @map("company_name")
  companyLogo      String?       @map("company_logo")
  industry         String?
  companySize      String?       @map("company_size")
  adminEmail       String        @unique @map("admin_email")
  adminName        String        @map("admin_name")
  passwordHash     String        @map("password_hash")
  subscriptionTier String        @default("free") @map("subscription_tier")
  role             String        @default("CLIENT")
  status           AccountStatus @default(ACTIVE) @map("status")

 // ğŸŒ INTERNACIONALIZACIÃ“N (Enterprise Multi-PaÃ­s)
  country  String  @default("CL") @map("country")      // ISO 3166-1 alpha-2: "CL", "AR", "MX", "BR", "CO", "PE"
  region   String? @map("region")                       // "LATAM", "EU", "ASIA", "NA" (opcional, para agrupaciÃ³n)
  timezone String  @default("America/Santiago") @map("timezone") // IANA timezone database
  locale   String  @default("es-CL") @map("locale")    // BCP 47 language tag: "es-CL", "es-AR", "pt-BR", "en-US"

  // Configuraciones parametrizables:
  maxActiveCampaigns         Int @default(1) @map("max_active_campaigns")
  maxParticipantsPerCampaign Int @default(500) @map("max_participants_per_campaign")
  maxCampaignDurationDays    Int @default(30) @map("max_campaign_duration_days")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  campaigns         Campaign[]
  auditLogs         AuditLog[]
  departments       Department[]
  users             User[]
  departmentMetrics DepartmentMetric[] // âœ… NUEVA RELACIÃ“N CHAT 9
  onboardingEffectivenessInsights OnboardingEffectivenessInsight[]  // â¬…ï¸ AGREGAR ESTA ES LA NUEVA

  // âœ… v3.2.2: NUEVAS RELACIONES ONBOARDING
  journeys           JourneyOrchestration[]
  journeyAlerts      JourneyAlert[]
  departmentInsights DepartmentOnboardingInsight[]
   
  // âœ… AGREGAR ESTA LÃNEA AQUÃ â†“
  npsInsights        NPSInsight[]
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONES EXIT INTELLIGENCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitRecords       ExitRecord[]
  exitAlerts        ExitAlert[]
  exitInsights      DepartmentExitInsight[]

  @@index([adminEmail], map: "idx_accounts_email")
  @@index([subscriptionTier], map: "idx_accounts_tier")
  // ğŸŒ AGREGAR ESTOS 3 ÃNDICES:
  @@index([country], map: "idx_accounts_country")
  @@index([region], map: "idx_accounts_region")
  @@index([country, industry], map: "idx_accounts_country_industry")
  @@map("accounts")
}

// TABLA 2: Tipos de campaÃ±a/estudio
model CampaignType {
  id                String  @id @default(cuid())
  name              String
  slug              String  @unique
  description       String?
  estimatedDuration Int?    @map("estimated_duration")
  questionCount     Int?    @map("question_count")
  methodology       String?
  category          String?
  isActive          Boolean @default(true) @map("is_active")
  sortOrder         Int     @default(0) @map("sort_order")

  // âœ… v3.2.2: PILAR 1 - isPermanent en CampaignType
  isPermanent Boolean @default(false) @map("is_permanent")
  // Agregar DEBAJO:
  flowType    String  @default("standard") @map("flow_type")

  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  campaigns           Campaign[]
  questions           Question[]
  surveyConfiguration SurveyConfiguration?

  @@index([isActive], map: "idx_campaign_types_active")
  @@index([category], map: "idx_campaign_types_category")
  @@index([isPermanent], map: "idx_campaign_types_ispermanent")
  @@map("campaign_types")
}

// TABLA 3: CampaÃ±as/estudios
model Campaign {
  id             String   @id @default(cuid())
  accountId      String   @map("account_id")
  campaignTypeId String   @map("campaign_type_id")
  name           String
  description    String?
  startDate      DateTime @map("start_date") @db.Date
  endDate        DateTime @map("end_date") @db.Date
  status         String   @default("draft")

  // ConfiguraciÃ³n campaÃ±a:
  sendReminders    Boolean @default(true) @map("send_reminders")
  anonymousResults Boolean @default(true) @map("anonymous_results")

  // Metadatos:
  createdByName  String?   @map("created_by_name")
  activatedAt    DateTime? @map("activated_at")
  completedAt    DateTime? @map("completed_at")
  totalInvited   Int       @default(0) @map("total_invited")
  totalResponded Int       @default(0) @map("total_responded")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  account          Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaignType     CampaignType      @relation(fields: [campaignTypeId], references: [id])
  participants     Participant[]
  campaignResults  CampaignResult?
  auditLogs        AuditLog[]
  emailLogs        EmailLog[]
  emailAutomations EmailAutomation[]

  @@index([accountId], map: "idx_campaigns_account")
  @@index([status], map: "idx_campaigns_status")
  @@index([campaignTypeId], map: "idx_campaigns_type")
  @@index([startDate, endDate], map: "idx_campaigns_dates")
  @@map("campaigns")
}

// TABLA 4: Participantes (carga manual backend)
model Participant {
  id          String  @id @default(cuid())
  campaignId  String  @map("campaign_id")
  email       String?
  uniqueToken String  @unique @map("unique_token")
  name        String?
  // ğŸ†• NUEVOS CAMPOS - AGREGAR ESTAS 2 LÃNEAS
  nationalId  String  @map("national_id") // RUT chileno (12345678-9)
  phoneNumber String? @map("phone_number") // Celular internacional (+56912345678)

  // SegmentaciÃ³n bÃ¡sica (carga manual):
  department     String?
  position       String?
  seniorityLevel String? @map("seniority_level")
  // ğŸ”® NUEVO CAMPO DE ALTO VALOR (Plan Benchmark)
  standardSeniority String? @map("standard_seniority")
  location       String?

  // Estados:
  hasResponded     Boolean   @default(false) @map("has_responded")
  responseDate     DateTime? @map("response_date")
  startedAt        DateTime? @map("started_at")
  reminderCount    Int       @default(0) @map("reminder_count")
  lastReminderSent DateTime? @map("last_reminder_sent")

  // Metadatos:
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  // Campos demogrÃ¡ficos:
  dateOfBirth  DateTime? @map("date_of_birth")
  gender       Gender?
  hireDate     DateTime? @map("hire_date") @db.Date
  departmentId String?   @map("department_id")

  // Relaciones
  campaign         Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  responses        Response[]
  emailLogs        EmailLog[]
  departmentRel    Department?       @relation(fields: [departmentId], references: [id])
  emailAutomations EmailAutomation[] // âœ… AGREGAR ESTA LÃNEA

  // âœ… v3.2.2: NUEVAS RELACIONES INVERSAS ONBOARDING (CRÃTICO compilaciÃ³n)
  journeyStage1 JourneyOrchestration? @relation("Stage1")
  journeyStage2 JourneyOrchestration? @relation("Stage2")
  journeyStage3 JourneyOrchestration? @relation("Stage3")
  journeyStage4 JourneyOrchestration? @relation("Stage4")
  // RelaciÃ³n con ExitRecord (1:1 opcional)
  exitRecord  ExitRecord?

  @@unique([campaignId, nationalId], map: "unique_campaign_rut")
  @@index([campaignId], map: "idx_participants_campaign")
  @@index([uniqueToken], map: "idx_participants_token")
  @@index([email], map: "idx_participants_email")
  @@index([hasResponded], map: "idx_participants_responded")
  @@index([department], map: "idx_participants_department")
  @@index([departmentId], map: "idx_participants_department_id")
  @@index([nationalId], map: "idx_participants_national_id") // ğŸ†• NUEVO ÃNDICE
  @@index([phoneNumber], map: "idx_participants_phone_number") // ğŸ†• NUEVO ÃNDICE
  @@index([standardSeniority])  // âœ… AGREGAR ESTE ÃNDICE AL FINAL
  @@map("participants")
}

// TABLA 5: Preguntas por tipo campaÃ±a
model Question {
  id               String  @id @default(cuid())
  campaignTypeId   String  @map("campaign_type_id")
  text             String
  category         String
  subcategory      String?
  questionOrder    Int     @map("question_order")
  responseType     String  @default("rating") @map("response_type")
  choiceOptions    Json?   @map("choice_options")
  // âœ… NUEVO - Metadata para normalizaciÃ³n
  responseValueMapping Json? @map("response_value_mapping")
  // Ejemplo: {"SÃ­, muy bien": 5.0, "Solo brevemente": 2.5, "No, nadie": 1.0}
  conditionalLogic Json?   @map("conditional_logic")

  // ConfiguraciÃ³n pregunta:
  isRequired Boolean @default(true) @map("is_required")
  isActive   Boolean @default(true) @map("is_active")
  minValue   Int     @default(1) @map("min_value")
  maxValue   Int     @default(5) @map("max_value")

  // Metadatos:
  methodologyReference String?  @map("methodology_reference")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relaciones
  campaignType CampaignType @relation(fields: [campaignTypeId], references: [id])
  responses    Response[]

  @@index([campaignTypeId], map: "idx_questions_campaign_type")
  @@index([category], map: "idx_questions_category")
  @@index([questionOrder], map: "idx_questions_order")
  @@index([isActive], map: "idx_questions_active")
  @@map("questions")
}

// TABLA 6: Respuestas colaboradores
model Response {
  id            String @id @default(cuid())
  participantId String @map("participant_id")
  questionId    String @map("question_id")

  // Respuestas:
  rating         Int?
  textResponse   String? @map("text_response")
  choiceResponse String? @map("choice_response")

  // âœ… NUEVO - Valor normalizado para inteligencia
  normalizedScore Float? @map("normalized_score")

  // Metadatos:
  responseTimeSeconds Int?     @map("response_time_seconds")
  createdAt           DateTime @default(now()) @map("created_at")

  // Relaciones
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id])

  @@index([participantId], map: "idx_responses_participant")
  @@index([questionId], map: "idx_responses_question")
  @@index([rating], map: "idx_responses_rating")
  @@index([normalizedScore], map: "idx_responses_normalized_score")  // âœ… NUEVO
  @@index([createdAt], map: "idx_responses_created")
  @@map("responses")
}

// TABLA 7: Resultados agregados + Kit ComunicaciÃ³n
model CampaignResult {
  id         String @id @default(cuid())
  campaignId String @unique @map("campaign_id")

  // MÃ©tricas principales:
  participationRate Decimal @map("participation_rate") @db.Decimal(5, 2)
  overallScore      Decimal @map("overall_score") @db.Decimal(3, 2)
  totalResponses    Int     @map("total_responses")

  // AnÃ¡lisis por categorÃ­a:
  categoryScores         Json  @map("category_scores")
  categoryResponseCounts Json? @map("category_response_counts")

  // AnÃ¡lisis bÃ¡sico por segmentaciÃ³n:
  segmentAnalysis  Json? @map("segment_analysis")
  departmentScores Json? @map("department_scores")
  positionScores   Json? @map("position_scores")

  // Kit comunicaciÃ³n:
  communicationInsights Json  @map("communication_insights")
  keyStrengths          Json? @map("key_strengths")
  keyOpportunities      Json? @map("key_opportunities")

  // Benchmarking bÃ¡sico:
  benchmarkComparison Json?    @map("benchmark_comparison")
  industryBenchmark   Decimal? @map("industry_benchmark") @db.Decimal(3, 2)

  // Metadatos:
  resultsData     Json?    @map("results_data")
  confidenceLevel String?  @map("confidence_level")
  generatedAt     DateTime @default(now()) @map("generated_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relaciones
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId], map: "idx_results_campaign")
  @@index([generatedAt], map: "idx_results_generated")
  @@map("campaign_results")
}

// TABLA 8: Templates Kit ComunicaciÃ³n - ARQUITECTURA CONTEXTUAL
model CommunicationTemplate {
  id                String  @id @default(cuid())
  templateType      String  @map("template_type")
  productContext    String  @default("general") @map("product_context")
  category          String?
  conditionRule     String  @map("condition_rule")
  templateText      String  @map("template_text")
  variablesRequired Json?   @map("variables_required")
  priority          Int     @default(0)
  isActive          Boolean @default(true) @map("is_active")

  // Metadatos:
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([templateType, productContext])
  @@index([category], map: "idx_templates_category")
  @@index([isActive], map: "idx_templates_active")
  @@index([priority], map: "idx_templates_priority")
  @@index([productContext], map: "idx_templates_product_context")
  @@map("communication_templates")
}

// TABLA 9: Audit Log (Para debugging y compliance)
model AuditLog {
  id         String   @id @default(cuid())
  accountId  String?  @map("account_id")
  campaignId String?  @map("campaign_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  userInfo   Json?    @map("user_info")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relaciones
  account  Account?  @relation(fields: [accountId], references: [id])
  campaign Campaign? @relation(fields: [campaignId], references: [id])

  @@index([accountId], map: "idx_audit_account")
  @@index([campaignId], map: "idx_audit_campaign")
  @@index([action], map: "idx_audit_action")
  @@index([createdAt], map: "idx_audit_created")
  @@map("audit_logs")
}

// TABLA 10: Email Logs para tracking
model EmailLog {
  id            String    @id @default(cuid())
  participantId String    @map("participant_id")
  campaignId    String    @map("campaign_id")
  emailType     String    @map("email_type")
  templateId    String    @map("template_id")
  sentAt        DateTime  @map("sent_at")
  deliveredAt   DateTime? @map("delivered_at")
  openedAt      DateTime? @map("opened_at")
  clickedAt     DateTime? @map("clicked_at")
  bouncedAt     DateTime? @map("bounced_at")
  complainedAt  DateTime? @map("complained_at")
  openCount     Int       @default(0) @map("open_count")
  clickCount    Int       @default(0) @map("click_count")
  status        String    @default("sent")
  bounceReason  String?   @map("bounce_reason")

  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  campaign    Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([participantId], map: "idx_email_logs_participant")
  @@index([campaignId], map: "idx_email_logs_campaign")
  @@index([emailType], map: "idx_email_logs_type")
  @@index([status], map: "idx_email_logs_status")
  @@index([sentAt], map: "idx_email_logs_sent")
  @@map("email_logs")
}

// TABLA 11: Email Automation Rules
model EmailAutomation {
  id            String    @id @default(cuid())
  campaignId    String    @map("campaign_id")
  participantId String    @map("participant_id") // âœ… AÃ‘ADIR ESTA LÃNEA
  triggerType   String    @map("trigger_type")
  triggerAt     DateTime  @map("trigger_at")
  processedAt   DateTime? @map("processed_at")
  enabled       Boolean   @default(true)
  templateId    String    @map("template_id")

  campaign    Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade) // âœ… AGREGAR ESTA LÃNEA

  @@index([campaignId], map: "idx_email_automation_campaign")
  @@index([participantId], map: "idx_email_automation_participant") // âœ… AÃ‘ADIR ESTE ÃNDICE
  @@index([triggerType], map: "idx_email_automation_type")
  @@index([triggerAt], map: "idx_email_automation_trigger")
  @@index([enabled], map: "idx_email_automation_enabled")
  @@map("email_automations")
}

// TABLA 12: DEPARTMENTS
model Department {
  id               String   @id @default(cuid())
  accountId        String   @map("account_id")
  displayName      String   @map("display_name")
  standardCategory String?  @map("standard_category")
  costCenterCode   String?  @unique @map("cost_center_code") // âœ… NUEVO CAMPO CHAT 9
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  // âœ… CLAUDE + GEMINI: Score y peso para ponderaciÃ³n
  accumulatedExoScore       Float?    @map("accumulated_exo_score")
  accumulatedExoJourneys    Int?      @map("accumulated_exo_journeys")
  
  // ğŸŒŸ TU IDEA: Metadatos de contexto para UI
  accumulatedPeriodCount    Int?      @map("accumulated_period_count")
  accumulatedLastUpdated    DateTime? @map("accumulated_last_updated")
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXIT - Gold Cache 12 meses (LENTE 2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  accumulatedEISScore          Float?    @map("accumulated_eis_score")
  accumulatedExitCount         Int?      @map("accumulated_exit_count")
  accumulatedExitPeriodCount   Int?      @map("accumulated_exit_period_count")
  accumulatedExitLastUpdated   DateTime? @map("accumulated_exit_last_updated")
  accumulatedConservationIndex Float?    @map("accumulated_conservation_index")
  accumulatedExitTopFactors    Json?     @map("accumulated_exit_top_factors")
  accumulatedExitENPS          Float?    @map("accumulated_exit_enps")
  accumulatedExitVoluntaryRate Float?    @map("accumulated_exit_voluntary_rate")

  // JerarquÃ­a
  parentId      String?      @map("parent_id")
  parent        Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      Department[] @relation("DepartmentHierarchy")
  unitType      String       @default("departamento") @map("unit_type")
  level         Int          @default(3)
  employeeCount Int          @default(0) @map("employee_count")

  // Contexto organizacional
  technicalComplexity String @default("media") @map("technical_complexity")
  emotionalComplexity String @default("media") @map("emotional_complexity")
  marketScarcity      String @default("normal") @map("market_scarcity")

  // Relaciones
  account      Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  participants Participant[]
  users        User[]
  metrics      DepartmentMetric[] // âœ… NUEVA RELACIÃ“N CHAT 9

  // âœ… v3.2.2: NUEVAS RELACIONES ONBOARDING
  onboardingInsights DepartmentOnboardingInsight[]
  journeys           JourneyOrchestration[]
  // âœ… AGREGAR ESTA LÃNEA AQUÃ â†“
  npsInsights        NPSInsight[]
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONES EXIT (agregar a relaciones existentes)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitRecords       ExitRecord[]
  exitInsights      DepartmentExitInsight[]
  exitAlerts        ExitAlert[]

  @@unique([accountId, displayName])
  @@index([accountId], map: "idx_departments_account")
  @@index([standardCategory], map: "idx_departments_category")
  @@index([isActive], map: "idx_departments_active")
  @@index([parentId], map: "idx_departments_parent")
  @@index([costCenterCode], map: "idx_departments_cost_center") // âœ… NUEVO ÃNDICE CHAT 9
  @@map("departments")
}

// TABLA 13: Survey Configurations
model SurveyConfiguration {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaignTypeId   String   @unique @map("campaign_type_id")
  categoryConfigs  Json     @default("{}") @map("category_configs")
  conditionalRules Json     @default("[]") @map("conditional_rules")
  uiSettings       Json     @default("{}") @map("ui_settings")
  validationRules  Json     @default("[]") @map("validation_rules")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  campaignType CampaignType @relation(fields: [campaignTypeId], references: [id], onDelete: Cascade)

  @@map("survey_configurations")
}

// TABLA 14: USERS - Sistema Multi-usuario
model User {
  id           String    @id @default(cuid())
  accountId    String    @map("account_id")
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         String    @default("VIEWER")
  departmentId String?   @map("department_id")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relaciones
  account    Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])

  @@index([accountId])
  @@index([email])
  @@map("users")
}

// ============================================
// âœ… TABLA 15: DEPARTMENT METRICS - CHAT 9
// ============================================
model DepartmentMetric {
  id           String @id @default(cuid())
  accountId    String @map("account_id")
  departmentId String @map("department_id")

  // PERÃODO (flexible)
  period      String // "2025-Q1", "2025-01", "2025"
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  periodType  String   @map("period_type") // "monthly", "quarterly", "semi-annual", "annual"

  // KPIs FASE 1 (Core metrics)
  turnoverRate       Float? @map("turnover_rate")
  absenceRate        Float? @map("absence_rate")
  issueCount         Int?   @map("issue_count")
  overtimeHoursTotal Float? @map("overtime_hours_total")
  overtimeHoursAvg   Float? @map("overtime_hours_avg")

  // CONTEXTO CÃLCULO (opcionales)
  headcountAvg          Float? @map("headcount_avg")
  turnoverCount         Int?   @map("turnover_count")
  absenceDaysTotal      Int?   @map("absence_days_total")
  workingDaysTotal      Int?   @map("working_days_total")
  overtimeEmployeeCount Int?   @map("overtime_employee_count")

  // FASE 1.5 (opcional - rotaciÃ³n lamentada)
  turnoverRegrettableRate  Float? @map("turnover_regrettable_rate")
  turnoverRegrettableCount Int?   @map("turnover_regrettable_count")

  // FASE 2 (preparado, nullables)
  performanceScore   Float? @map("performance_score")
  goalsAchievedRate  Float? @map("goals_achieved_rate")
  trainingHoursAvg   Float? @map("training_hours_avg")
  salaryIncreaseRate Float? @map("salary_increase_rate")
  promotionRate      Float? @map("promotion_rate")

  // METADATA
  uploadedBy   String   @map("uploaded_by")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  uploadMethod String   @default("manual") @map("upload_method")
  dataQuality  String   @default("validated") @map("data_quality")
  notes        String?

  // RELACIONES
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  account    Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // CONSTRAINTS E ÃNDICES
  @@unique([departmentId, period], name: "departmentId_period")
  @@index([accountId, periodStart, periodEnd], map: "idx_dept_metrics_account_period")
  @@index([accountId, periodType], map: "idx_dept_metrics_period_type")
  @@index([departmentId, periodStart], map: "idx_dept_metrics_department")
  @@index([dataQuality], map: "idx_dept_metrics_quality")
  @@index([uploadedAt], map: "idx_dept_metrics_uploaded")
  @@map("department_metrics")
}

// ============================================
// âœ… ONBOARDING JOURNEY INTELLIGENCE v3.2.2
// ============================================

// MODELO NUEVO 1: JourneyOrchestration
model JourneyOrchestration {
  id               String   @id @default(cuid())
  accountId        String   @map("account_id")
  nationalId       String   @map("national_id")
  fullName         String   @map("full_name")
  participantEmail String?  @map("participant_email")
  phoneNumber      String?  @map("phone_number")
  departmentId     String   @map("department_id")
  position         String?
  hireDate         DateTime @map("hire_date") @db.Date

  // IDs Participants (4 stages) - âœ… @unique para relaciones 1:1
  stage1ParticipantId String? @unique @map("stage1_participant_id")
  stage2ParticipantId String? @unique @map("stage2_participant_id")
  stage3ParticipantId String? @unique @map("stage3_participant_id")
  stage4ParticipantId String? @unique @map("stage4_participant_id")

  // Scores 4C
  complianceScore    Float? @map("compliance_score")
  clarificationScore Float? @map("clarification_score")
  cultureScore       Float? @map("culture_score")
  connectionScore    Float? @map("connection_score")

  // EXO Score
  exoScore Float? @map("exo_score")

  // Fechas completitud
  stage1CompletedAt DateTime? @map("stage1_completed_at")
  stage2CompletedAt DateTime? @map("stage2_completed_at")
  stage3CompletedAt DateTime? @map("stage3_completed_at")
  stage4CompletedAt DateTime? @map("stage4_completed_at")

  // Estado
  currentStage  Int     @default(0) @map("current_stage")
  status        String  @default("active")
  retentionRisk String? @map("retention_risk") // âœ… CORREGIDO v3.2.2

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  account           Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department        Department     @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  stage1Participant Participant?   @relation("Stage1", fields: [stage1ParticipantId], references: [id], onDelete: SetNull)
  stage2Participant Participant?   @relation("Stage2", fields: [stage2ParticipantId], references: [id], onDelete: SetNull)
  stage3Participant Participant?   @relation("Stage3", fields: [stage3ParticipantId], references: [id], onDelete: SetNull)
  stage4Participant Participant?   @relation("Stage4", fields: [stage4ParticipantId], references: [id], onDelete: SetNull)
  alerts            JourneyAlert[]

  @@unique([accountId, nationalId])
  @@index([accountId])
  @@index([nationalId])
  @@index([departmentId])
  @@index([status])
  @@index([currentStage])
  @@index([retentionRisk])
  @@index([hireDate])
  @@map("journey_orchestrations")
}

// MODELO NUEVO 2: JourneyAlert
model JourneyAlert {
  id        String @id @default(cuid())
  journeyId String @map("journey_id")
  accountId String @map("account_id")

  // Tipo alerta
  alertType   String  @map("alert_type")
  severity    String
  title       String
  description String
  dimension   String? // â† NUEVO: compliance, clarification, culture, connection
  score       Float? // Para 'low_score': El score promedio (ej. 1.3)

  // Contexto
  stage         Int?
  questionId    String? @map("question_id")
  responseValue Float?  @map("response_value")
  threshold     Float?

  // GestiÃ³n
  status          String    @default("pending")
  acknowledgedAt  DateTime? @map("acknowledged_at") // â† NUEVO
  acknowledgedBy  String?   @map("acknowledged_by") // â† NUEVO
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by")
  resolutionNotes String?   @map("resolution_notes")

  // SLA (SISTEMA CORRECTO v3.2.2)
  slaHours  Int      @map("sla_hours") // âœ… CORREGIDO
  dueDate   DateTime @map("due_date") // âœ… CORREGIDO
  slaStatus String   @map("sla_status") // âœ… CORREGIDO (obligatorio)

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  journey JourneyOrchestration @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  account Account              @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([journeyId])
  @@index([accountId])
  @@index([status])
  @@index([severity])
  @@index([alertType])
  @@index([slaStatus, dueDate])
  @@map("journey_alerts")
}

// MODELO NUEVO 3: DepartmentOnboardingInsight
model DepartmentOnboardingInsight {
  id           String   @id @default(cuid())
  accountId    String   @map("account_id")
  departmentId String   @map("department_id")
  periodStart  DateTime @map("period_start") @db.Date
  periodEnd    DateTime @map("period_end") @db.Date

  // MÃ©tricas
  totalJourneys     Int @default(0) @map("total_journeys")
  activeJourneys    Int @default(0) @map("active_journeys")
  completedJourneys Int @default(0) @map("completed_journeys")
  atRiskJourneys    Int @default(0) @map("at_risk_journeys")
  abandonedJourneys Int @default(0) @map("abandoned_journeys")

  // Scores 4C
  avgComplianceScore    Float? @map("avg_compliance_score")
  avgClarificationScore Float? @map("avg_clarification_score")
  avgCultureScore       Float? @map("avg_culture_score")
  avgConnectionScore    Float? @map("avg_connection_score")

  // EXO Score
  avgEXOScore   Float? @map("avg_exo_score")
  exoScoreTrend Float? @map("exo_score_trend") // â¬…ï¸ AGREGAR ESTA LÃNEA

  // Alertas
  criticalAlerts Int @default(0) @map("critical_alerts")
  highAlerts     Int @default(0) @map("high_alerts")
  mediumAlerts   Int @default(0) @map("medium_alerts")

  // Patterns
  topIssues          Json?  @map("top_issues")
  recommendations    Json?
  // ğŸ†• DEMOGRAFÃA (Agregar estos 3 campos)
  avgAge             Float? @map("avg_age")
  avgSeniority       Float? @map("avg_seniority")
  genderDistribution Json?  @map("gender_distribution")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  account    Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, periodStart, periodEnd], map: "unique_department_period")
  @@index([accountId])
  @@index([departmentId])
  @@index([periodStart, periodEnd])
  @@map("department_onboarding_insights")
}

// ==========================================
// ğŸ›ï¸ ARQUITECTURA BENCHMARK ENTERPRISE
// ==========================================

model MarketBenchmark {
  id String @id @default(cuid())

  // ğŸŒ SEGMENTACIÃ“N ESTRUCTURAL
  country          String  @map("country")
  industry         String  @map("industry")
  companySizeRange String  @map("company_size_range")
  standardCategory String  @map("standard_category")

  // ğŸ‘¥ SEGMENTACIÃ“N DEMOGRÃFICA
  dimension        String  @default("GLOBAL") @map("dimension")
  segment          String  @default("ALL")    @map("segment")

  // ğŸ“¦ CONTEXTO
  metricType       String  @map("metric_type")
  metricSource     String  @map("metric_source")
  
  // ğŸ“… TIEMPO
  periodType       String  @default("monthly") @map("period_type")
  periodStart      DateTime @db.Date @map("period_start")
  periodEnd        DateTime @db.Date @map("period_end")
  period           String  @map("period")

  // ğŸ“Š ESTADÃSTICAS
  avgScore         Float   @map("avg_score")
  medianScore      Float   @map("median_score")
  percentile25     Float   @map("percentile_25")
  percentile75     Float   @map("percentile_75")
  percentile90     Float   @map("percentile_90")
  
  stdDeviation     Float   @map("std_deviation")
  sampleSize       Int     @map("sample_size")
  companyCount     Int     @map("company_count")

  // ğŸ”’ CONTROL
  isPublic         Boolean @default(false) @map("is_public")
  isActive         Boolean @default(true)  @map("is_active")
  version          String  @default("v1.0") @map("calculation_version")
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // âœ… CONSTRAINT CORREGIDO (Todo en una lÃ­nea)
  @@unique([country, industry, companySizeRange, standardCategory, dimension, segment, metricType, period], name: "unique_market_benchmark")
  
  // ÃNDICES
  @@index([metricType, country, industry], map: "idx_benchmark_lookup")
  @@index([isPublic, metricType], map: "idx_benchmark_public")
  @@index([dimension, segment], map: "idx_benchmark_demographic")
  @@index([period], map: "idx_benchmark_period")
  
  @@map("market_benchmarks")
}
// ============================================================================
// MODELO NUEVO: OnboardingEffectivenessInsight


// Tabla para guardar insights agregados mensuales por account
// CorrelaciÃ³n: Alertas gestionadas vs ignoradas â†’ RetenciÃ³n
// 
// PROPÃ“SITO:
// - Demostrar ROI sistema de alertas onboarding
// - AnÃ¡lisis efectividad gestiÃ³n alertas
// - Insights para mejora continua
// 
// FASE ACTUAL (AnÃ¡lisis Simple):
// - MÃ©tricas agregadas por mes
// - RetenciÃ³n gestionadas vs ignoradas
// - Score improvement promedio
// - ROI estimado en CLP

model OnboardingEffectivenessInsight {
  id        String   @id @default(cuid())
  accountId String   @map("account_id")
  period    String   // Formato: "2025-11" (YYYY-MM)
  
  // ============================================================================
  // ALERTAS GESTIONADAS
  // ============================================================================
  totalAlerts            Int   @default(0) @map("total_alerts")
  managedCount           Int   @default(0) @map("managed_count")
  managedRetained        Int   @default(0) @map("managed_retained")
  managedRetentionRate   Float @default(0) @map("managed_retention_rate")   // 0.75 = 75%
  managedAvgScoreChange  Float @default(0) @map("managed_avg_score_change") // +15.5 puntos
  
  // ============================================================================
  // ALERTAS IGNORADAS
  // ============================================================================
  ignoredCount           Int   @default(0) @map("ignored_count")
  ignoredRetained        Int   @default(0) @map("ignored_retained")
  ignoredRetentionRate   Float @default(0) @map("ignored_retention_rate")   // 0.20 = 20%
  ignoredAvgScoreChange  Float @default(0) @map("ignored_avg_score_change") // -5.2 puntos
  
  // ============================================================================
  // INSIGHTS CALCULADOS
  // ============================================================================
  retentionDelta         Float @default(0) @map("retention_delta")  // +55 puntos porcentuales
  estimatedROI           Float @default(0) @map("estimated_roi")     // $86,400,000 CLP ahorro
  
  // ============================================================================
  // METADATA
  // ============================================================================
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // ============================================================================
  // RELACIONES
  // ============================================================================
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // ============================================================================
  // ÃNDICES
  // ============================================================================
  @@unique([accountId, period])
  @@index([accountId])
  @@index([period])
  @@map("onboarding_effectiveness_insights")
}

// ============================================
// NPSInsight - Sistema NPS Transversal FocalizaHR
// ============================================
// PatrÃ³n: DepartmentOnboardingInsight
// PropÃ³sito: Centralizar NPS de todos los productos
// VersiÃ³n: 1.0 - Diciembre 2025
// ============================================
// 
// INSTRUCCIONES DE INTEGRACIÃ“N:
// 1. Copiar este modelo al final de prisma/schema.prisma
// 2. Agregar la relaciÃ³n al modelo Account:
//    npsInsights NPSInsight[]
// 3. Agregar la relaciÃ³n al modelo Department:
//    npsInsights NPSInsight[]
// 4. Ejecutar: npx prisma migrate dev --name add_nps_insight_model
// ============================================

model NPSInsight {
  id              String    @id @default(cuid())
  accountId       String    @map("account_id")
  departmentId    String?   @map("department_id")  // NULL = empresa completa
  
  // ========================================
  // DIMENSIÃ“N: Producto
  // ========================================
  productType     String    @map("product_type")   // onboarding | exit | pulso | experiencia
  
  // ========================================
  // DIMENSIÃ“N: PerÃ­odo (patrÃ³n FocalizaHR)
  // ========================================
  period          String                            // "2025-12" | "2025-Q4" | "2025"
  periodType      String    @map("period_type")    // monthly | quarterly | yearly
  periodStart     DateTime  @map("period_start")
  periodEnd       DateTime  @map("period_end")
  
  // ========================================
  // MÃ‰TRICAS NPS
  // ========================================
  npsScore        Int       @map("nps_score")      // -100 a +100
  promoters       Int                               // Cantidad (rating 9-10)
  passives        Int                               // Cantidad (rating 7-8)
  detractors      Int                               // Cantidad (rating 0-6)
  totalResponses  Int       @map("total_responses")
  
  // Porcentajes pre-calculados (performance)
  promotersPct    Float     @map("promoters_pct")  // 0-100
  passivesPct     Float     @map("passives_pct")   // 0-100
  detractorsPct   Float     @map("detractors_pct") // 0-100
  
  // ========================================
  // TREND (vs perÃ­odo anterior)
  // ========================================
  previousScore   Int?      @map("previous_score")
  scoreDelta      Int?      @map("score_delta")    // +5, -10, 0
  
  // ========================================
  // METADATA
  // ========================================
  calculatedAt    DateTime  @default(now()) @map("calculated_at")
  
  // ========================================
  // RELACIONES
  // ========================================
  account         Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department      Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // ========================================
  // ÃNDICES Y CONSTRAINTS
  // ========================================
  // Clave Ãºnica compuesta (nombre auto-generado: accountId_departmentId_productType_period_periodType)
  @@unique([accountId, departmentId, productType, period, periodType])
  
  // Ãndices para queries frecuentes
  @@index([accountId, periodType, period])
  @@index([accountId, productType])
  @@index([departmentId])
  
  @@map("nps_insights")
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXIT INTELLIGENCE - CAMBIOS AL SCHEMA PRISMA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fecha: Diciembre 2025
// VersiÃ³n: 1.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECCIÃ“N 1: MODELOS NUEVOS (agregar al final de schema.prisma)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ============================================
// âœ… EXIT INTELLIGENCE v1.0
// ============================================

// MODELO EXIT 1: ExitRecord
model ExitRecord {
  id            String   @id @default(cuid())
  accountId     String   @map("account_id")
  departmentId  String   @map("department_id")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VÃNCULO AL SISTEMA EXISTENTE (1:1 con Participant)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  participantId String   @unique @map("participant_id")
  nationalId    String   @map("national_id")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATOS EXCLUSIVOS DE EXIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitDate      DateTime @map("exit_date") @db.Date
  exitReason    String?  @map("exit_reason") // voluntary|termination|contract_end|retirement|other

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EIS - EXIT INTELLIGENCE SCORE (calculado)
  // FÃ³rmula: 20%P1 + 25%P4 + 20%P5 + 25%P6 + 10%P7
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  eis               Float?   @map("eis")
  eisClassification String?  @map("eis_classification") // healthy|neutral|problematic|toxic

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // P2 + P3: CAUSAS RAÃZ (factores cualitativos)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitFactors       String[] @map("exit_factors")        // Multi-select P2
  exitFactorsDetail Json?    @map("exit_factors_detail") // Matrix P3 {factor: score}
  exitFactorsAvg    Float?   @map("exit_factors_avg")    // Promedio severidad

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CORRELACIÃ“N ONBOARDING (detectada por nationalId)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  hadOnboarding           Boolean  @default(false) @map("had_onboarding")
  onboardingJourneyId     String?  @map("onboarding_journey_id")
  onboardingEXOScore      Float?   @map("onboarding_exo_score")
  onboardingAlertsCount   Int      @default(0) @map("onboarding_alerts_count")
  onboardingIgnoredAlerts Int      @default(0) @map("onboarding_ignored_alerts")
  onboardingManagedAlerts Int      @default(0) @map("onboarding_managed_alerts")
  tenureMonths            Int?     @map("tenure_months")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RED FLAGS (detecciÃ³n automÃ¡tica)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  hasLeyKarinAlert        Boolean  @default(false) @map("has_ley_karin_alert")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  participant   Participant  @relation(fields: [participantId], references: [id], onDelete: Cascade)
  account       Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department    Department   @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  alerts        ExitAlert[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ÃNDICES OPTIMIZADOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  @@index([accountId, exitDate], map: "idx_exit_records_account_date")
  @@index([departmentId, exitDate], map: "idx_exit_records_department_date")
  @@index([nationalId], map: "idx_exit_records_national_id")
  @@index([eis], map: "idx_exit_records_eis")
  @@index([eisClassification], map: "idx_exit_records_classification")
  @@index([hasLeyKarinAlert], map: "idx_exit_records_ley_karin")
  @@map("exit_records")
}

// MODELO EXIT 2: ExitAlert (alertas departamentales, no individuales)
model ExitAlert {
  id            String    @id @default(cuid())
  exitRecordId  String?   @map("exit_record_id") // Opcional: puede ser alerta de patrÃ³n
  accountId     String    @map("account_id")
  departmentId  String    @map("department_id")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIPO DE ALERTA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  alertType     String    @map("alert_type")
  // Tipos vÃ¡lidos:
  // - ley_karin: P6 < 2.5 (ambiente no seguro)
  // - liderazgo_concentracion: 3+ exits mismo factor liderazgo
  // - nps_critico: eNPS < -30 en departamento
  // - toxic_exit_detected: EIS < 40 individual
  // - department_exit_pattern: PatrÃ³n normalizado departamental
  // - onboarding_exit_correlation: CorrelaciÃ³n alertas ignoradas

  severity      String    // critical|high|medium|low
  title         String
  description   String

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTEXTO POR TIPO (campos dinÃ¡micos)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  triggerScore    Float?    @map("trigger_score")   // Score que disparÃ³ alerta
  exitCount       Int?      @map("exit_count")      // Exits involucrados en patrÃ³n
  triggerFactor   String?   @map("trigger_factor")  // Factor P2/P3 predominante
  avgScore        Float?    @map("avg_score")       // Score promedio del patrÃ³n
  enpsValue       Float?    @map("enps_value")      // eNPS del departamento
  periodStart     DateTime? @map("period_start")    // Inicio perÃ­odo anÃ¡lisis
  periodEnd       DateTime? @map("period_end")      // Fin perÃ­odo anÃ¡lisis

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GESTIÃ“N (patrÃ³n idÃ©ntico a JourneyAlert)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status          String    @default("pending") // pending|acknowledged|resolved|dismissed
  acknowledgedAt  DateTime? @map("acknowledged_at")
  acknowledgedBy  String?   @map("acknowledged_by")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by")
  resolutionNotes String?   @map("resolution_notes") @db.Text

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SLA (trackeable pero sin presiÃ³n urgente como Onboarding)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  slaHours        Int?      @map("sla_hours")   // Sugerido, no obligatorio
  dueDate         DateTime? @map("due_date")
  slaStatus       String?   @map("sla_status")  // on_track|at_risk|breached|null

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  createdAt       DateTime  @default(now()) @map("created_at")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitRecord      ExitRecord? @relation(fields: [exitRecordId], references: [id], onDelete: Cascade)
  department      Department  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  account         Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ÃNDICES OPTIMIZADOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  @@index([accountId, status], map: "idx_exit_alerts_account_status")
  @@index([departmentId, status], map: "idx_exit_alerts_department_status")
  @@index([alertType, status], map: "idx_exit_alerts_type_status")
  @@index([severity, status], map: "idx_exit_alerts_severity_status")
  @@index([createdAt], map: "idx_exit_alerts_created")
  @@map("exit_alerts")
}

// MODELO EXIT 3: DepartmentExitInsight (agregaciÃ³n mensual LENTE 1)
model DepartmentExitInsight {
  id            String   @id @default(cuid())
  accountId     String   @map("account_id")
  departmentId  String   @map("department_id")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PERÃODO (patrÃ³n FocalizaHR)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  period        String   // "2025-12", "2025-Q4", "2025"
  periodType    String   @default("monthly") @map("period_type") // monthly|quarterly|yearly
  periodStart   DateTime @map("period_start") @db.Date
  periodEnd     DateTime @map("period_end") @db.Date

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MÃ‰TRICAS BÃSICAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  totalExits        Int @default(0) @map("total_exits")
  voluntaryExits    Int @default(0) @map("voluntary_exits")
  involuntaryExits  Int @default(0) @map("involuntary_exits")
  surveysCompleted  Int @default(0) @map("surveys_completed")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCORES PROMEDIO (de ExitRecord)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  avgSatisfaction   Float? @map("avg_satisfaction")   // P1
  avgFactorsScore   Float? @map("avg_factors_score")  // P3 promedio
  avgLeadership     Float? @map("avg_leadership")     // P4
  avgDevelopment    Float? @map("avg_development")    // P5
  avgSafety         Float? @map("avg_safety")         // P6 (Ley Karin)
  avgAutonomy       Float? @map("avg_autonomy")       // P7
  avgNPS            Float? @map("avg_nps")            // P8 (0-10)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EIS AGREGADO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  avgEIS            Float? @map("avg_eis")
  eisTrend          Float? @map("eis_trend") // vs perÃ­odo anterior

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // eNPS DEPARTAMENTAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  enps              Float? @map("enps") // -100 a +100
  promoters         Int    @default(0)  // 9-10
  passives          Int    @default(0)  // 7-8
  detractors        Int    @default(0)  // 0-6

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TOP FACTORES P2+P3 (causas raÃ­z agregadas)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  topExitFactors    Json?  @map("top_exit_factors")
  // Estructura: [{ factor: string, mentions: number, mentionRate: number, avgSeverity: number }]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CORRELACIÃ“N ONBOARDING (ÃšNICO DIFERENCIADOR)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  exitsWithOnboarding       Int    @default(0) @map("exits_with_onboarding")
  exitsWithOnboardingAlerts Int    @default(0) @map("exits_with_onboarding_alerts")
  exitsWithIgnoredAlerts    Int    @default(0) @map("exits_with_ignored_alerts")
  avgOnboardingEXOOfExits   Float? @map("avg_onboarding_exo_of_exits")
  conservationIndex         Float? @map("conservation_index")      // % que recibiÃ³ alerta y NO se fue
  alertPredictionRate       Float? @map("alert_prediction_rate")   // % exits que tuvieron alerta previa

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ALERTAS GENERADAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  alertsGenerated           Int @default(0) @map("alerts_generated")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  calculatedAt              DateTime @default(now()) @map("calculated_at")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  account     Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  department  Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONSTRAINTS E ÃNDICES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  @@unique([departmentId, period, periodType])
  @@index([accountId], map: "idx_dept_exit_insights_account")
  @@index([departmentId], map: "idx_dept_exit_insights_department")
  @@index([periodStart, periodEnd], map: "idx_dept_exit_insights_period")
  @@index([avgEIS], map: "idx_dept_exit_insights_eis")
  @@index([avgSafety], map: "idx_dept_exit_insights_safety")
  @@map("department_exit_insights")
}
